<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Mroonga | massat log]]></title>
  <link href="http://massat.github.io/blog/categories/mroonga/atom.xml" rel="self"/>
  <link href="http://massat.github.io/"/>
  <updated>2016-03-04T09:45:50+09:00</updated>
  <id>http://massat.github.io/</id>
  <author>
    <name><![CDATA[Masato Hirai a.k.a. massat]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Amazon AMIにmroongaをインストールする]]></title>
    <link href="http://massat.github.io/blog/2013/08/20/install-mroonga-on-amazon-linux-ami/"/>
    <updated>2013-08-20T18:08:00+09:00</updated>
    <id>http://massat.github.io/blog/2013/08/20/install-mroonga-on-amazon-linux-ami</id>
    <content type="html"><![CDATA[<p>EC2上にmroongaによって全文検索可能なDBを構築した。</p>

<!-- more -->


<h1>環境</h1>

<ul>
<li>amzn-ami-pv-2013.03.1.x86_64-ebs (ami-39b23d38)</li>
<li>mysql5.6.13</li>
<li>groonga3.06</li>
<li>mroonga3.06</li>
</ul>


<p>mysqlはオフィシャルで配布してるrpmパッケージから。
groonga、mroongaはソースからビルドしてインストールした。</p>

<h1>準備</h1>

<h3>checkinstall</h3>

<p>ソースからビルドするものについても、checkinstallでrpm化してインストールする。
64bit版のAMIにcheckinstallをインストールする手順は<a href="http://massat.jp/blog/2013/02/16/install-checkinstall-on-amazon-ami-64bit/">こちら</a>を参照</p>

<h1>MySQLのインストール</h1>

<p>オフィシャルで配布されている Linux Generic な rpm をインストール</p>

<p><code>sh
~ # rpm -ivh http://dev.mysql.com/get/Downloads/MySQL-5.6/MySQL-shared-compat-5.6.13-1.linux_glibc2.5.x86_64.rpm/from/http://cdn.mysql.com/
~ # rpm -ivh http://dev.mysql.com/get/Downloads/MySQL-5.6/MySQL-server-5.6.13-1.linux_glibc2.5.x86_64.rpm/from/http://cdn.mysql.com/
~ # rpm -ivh http://dev.mysql.com/get/Downloads/MySQL-5.6/MySQL-devel-5.6.13-1.linux_glibc2.5.x86_64.rpm/from/http://cdn.mysql.com/
~ # rpm -ivh http://dev.mysql.com/get/Downloads/MySQL-5.6/MySQL-client-5.6.13-1.linux_glibc2.5.x86_64.rpm/from/http://cdn.mysql.com/
</code></p>

<p>デフォルトの<code>my.cnf</code>の場所が<code>/usr/my.cnf</code>になったみたい。
あと、mysql5.6からはデフォルトの<code>sql_mode</code>が変わって<a href="https://www.google.co.jp/search?q=mysql+5.6+sql_mode">よくエラーになるらしいので注意</a></p>

<h1>MeCabのインストール</h1>

<p><code>sh
~ # yum install mecab mecab-devel mecab-ipadic
</code></p>

<h1>groongaのインストール</h1>

<h3>ビルドに必要なライブラリ</h3>

<p>要らないものもあるかも</p>

<p><code>sh
~ # yum install gcc-c++ make automake libtool
</code></p>

<h3>インストール</h3>

<p>だいたいは<a href="http://groonga.org/ja/docs/install/centos.html#build-from-source">ここ</a>の手順に従った。</p>

<p><code>sh
~ # cd /usr/local/src/
src # wget http://packages.groonga.org/source/groonga/groonga-3.0.6.tar.gz
src # tar xzf groonga-3.0.6.tar.gz
src # cd groonga-3.0.6
groonga-3.0.6 # ./configure
groonga-3.0.6 # make -j$(grep '^processor' /proc/cpuinfo | wc -l)
</code></p>

<p>んで、<code>make install</code> ではなくて <code>checkinstall</code> でrpmにする。</p>

<p><code>sh
groonga-3.0.6 # checkinstall
</code></p>

<p>だけどコケる。
checkinstallがmake中に、どうやら必要なディレクトリが作れていない。
試行錯誤の末、以下のディレクトリを作ればビルドできる（と思う）</p>

<p><code>sh
groonga-3.0.6 # mkdir -p /usr/local/include/groonga/groonga
groonga-3.0.6 # mkdir -p /usr/local/lib/groonga/plugins/tokenizers
groonga-3.0.6 # mkdir -p /usr/local/lib/groonga/plugins/suggest
groonga-3.0.6 # mkdir -p /usr/local/lib/groonga/plugins/table
groonga-3.0.6 # mkdir -p /usr/local/lib/groonga/plugins/query_expanders
groonga-3.0.6 # mkdir -p /usr/local/etc/groonga
groonga-3.0.6 # mkdir -p /usr/local/var/run/groonga
groonga-3.0.6 # mkdir -p /usr/local/var/log/groonga/httpd
groonga-3.0.6 # mkdir -p /usr/local/share/groonga/examples/dictionary/edict
groonga-3.0.6 # mkdir -p /usr/local/share/groonga/examples/dictionary/html/css/smoothness/images
groonga-3.0.6 # mkdir -p /usr/local/share/groonga/images/logo
groonga-3.0.6 # mkdir -p /usr/local/share/doc/groonga/en/html/reference/command
groonga-3.0.6 # mkdir -p /usr/local/share/doc/groonga/en/html/_sources/contribution/development
groonga-3.0.6 # mkdir -p /usr/local/share/doc/groonga/en/html/_sources/reference/api
groonga-3.0.6 # mkdir -p /usr/local/share/doc/groonga/en/html/server/http
groonga-3.0.6 # mkdir -p /usr/local/share/doc/groonga/en/html/_sources/server/http
</code></p>

<p>その上で、checkinstallでrpmを作ってインストール</p>

<p><code>sh
groonga-3.0.6 # checkinstall
groonga-3.0.6 # rpm -ivh /root/rpmbuild/RPMS/x86_64/groonga-3.0.6-1.x86_64.rpm
</code></p>

<h3>mroongaのインストール</h3>

<p>手順はほぼ<a href="http://mroonga.org/ja/docs/install.html#install-from-the-source-code">こちら</a>の通り</p>

<p>まずはMySQLのソースコードがmroongaのビルドに必要なので落としてくる。</p>

<p><code>sh
src # wget http://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.13.tar.gz/from/http://cdn.mysql.com/
src # tar xzf mysql-5.6.13.tar.gz
</code></p>

<p>mroongaのソースコードを取得後、ビルドしてインストール。</p>

<p><code>sh
src # wget http://packages.groonga.org/source/mroonga/mroonga-3.06.tar.gz
src # tar xzf mroonga-3.06.tar.gz
src # cd mroonga-3.06
mroonga-3.06 # ./configure PKG_CONFIG_PATH=/usr/local/lib/pkgconfig  --with-mysql-source=/usr/local/src/mysql-5.6.13 --with-mysql-config=/usr/bin/mysql_config
mroonga-3.06 # make
mroonga-3.06 # checkinstall
</code></p>

<p>んが、groongaの時と同様に、ディレクトリが作れずこける。
ので、手対応。</p>

<p><code>sh
mroonga-3.06 # mkdir -p '/usr/local/share/doc/mroonga/en/html/_sources/dev
mroonga-3.06 # mkdir -p '/usr/local/share/doc/mroonga/source/reference'
mroonga-3.06 # checkinstall
mroonga-3.06 # rpm -ivh /root/rpmbuild/RPMS/x86_64/mroonga-3.06-1.x86_64.rpm
</code></p>

<p>MySQL起動後、mroongaをプラグインとしてインストールする。</p>

<p>```sql
mysql> INSTALL PLUGIN mroonga SONAME &lsquo;ha_mroonga.so&rsquo;;
Query OK, 0 rows affected (0.30 sec)</p>

<p>mysql> CREATE FUNCTION last_insert_grn_id RETURNS INTEGER SONAME &lsquo;ha_mroonga.so&rsquo;;
Query OK, 0 rows affected (0.00 sec)</p>

<p>mysql> CREATE FUNCTION mroonga_snippet RETURNS STRING SONAME &lsquo;ha_mroonga.so&rsquo;;
Query OK, 0 rows affected (0.00 sec)</p>

<p>mysql> CREATE FUNCTION mroonga_command RETURNS STRING SONAME &lsquo;ha_mroonga.so&rsquo;;
Query OK, 0 rows affected (0.00 sec)</p>

<p>mysql> show engines;
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |
| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |
| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |
| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |
| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |
| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |
| mroonga            | YES     | CJK-ready fulltext search, column store                        | NO           | NO   | NO         |
| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |
| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |
| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |
+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
10 rows in set (0.02 sec)
```</p>
]]></content>
  </entry>
  
</feed>
